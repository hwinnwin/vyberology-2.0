name: Compute System Frequency

on:
  push:
    branches: [main, develop]
    paths:
      - 'scripts/**'
      - 'A3-governance/**'
      - 'A4-architecture/**'
      - 'A5-implementation/**'
      - 'manifest.yaml'
  pull_request:
    branches: [main]
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      run_demo:
        description: 'Run with demo data'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  compute-frequency:
    name: Calculate F_total
    runs-on: ubuntu-latest

    outputs:
      f_total: ${{ steps.compute.outputs.f_total }}
      band: ${{ steps.compute.outputs.band }}
      diamond_ready: ${{ steps.compute.outputs.diamond_ready }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Run frequency calculation
        id: compute
        run: |
          # Determine if using demo mode
          if [ "${{ github.event.inputs.run_demo }}" == "true" ] || [ ! -f "manifest.yaml" ]; then
            echo "Running in demo mode..."
            RESULT=$(python scripts/compute_f_total.py --demo --json)
          else
            echo "Running with manifest configuration..."
            RESULT=$(python scripts/compute_f_total.py -m manifest.yaml --json)
          fi

          # Parse JSON output
          F_TOTAL=$(echo $RESULT | python -c "import sys, json; print(json.load(sys.stdin)['f_total'])")
          BAND=$(echo $RESULT | python -c "import sys, json; print(json.load(sys.stdin)['band'])")
          DIAMOND_READY=$(echo $RESULT | python -c "import sys, json; print(json.load(sys.stdin)['ready_for_diamond_hands'])")

          echo "f_total=$F_TOTAL" >> $GITHUB_OUTPUT
          echo "band=$BAND" >> $GITHUB_OUTPUT
          echo "diamond_ready=$DIAMOND_READY" >> $GITHUB_OUTPUT

          echo "## Frequency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| F_total | $F_TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "| Band | $BAND |" >> $GITHUB_STEP_SUMMARY
          echo "| Diamond Hands Ready | $DIAMOND_READY |" >> $GITHUB_STEP_SUMMARY

      - name: Generate evidence bundle
        run: |
          if [ "${{ github.event.inputs.run_demo }}" == "true" ] || [ ! -f "manifest.yaml" ]; then
            python scripts/compute_f_total.py --demo -o evidence/A7-bundle
          else
            python scripts/compute_f_total.py -m manifest.yaml -o evidence/A7-bundle
          fi

      - name: Upload evidence bundle
        uses: actions/upload-artifact@v4
        with:
          name: evidence-bundle-${{ github.run_number }}
          path: evidence/A7-bundle/
          retention-days: 90

  validate-evidence:
    name: Validate Evidence Bundle
    runs-on: ubuntu-latest
    needs: compute-frequency

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download evidence bundle
        uses: actions/download-artifact@v4
        with:
          name: evidence-bundle-${{ github.run_number }}
          path: evidence/A7-bundle/

      - name: Validate bundle structure
        run: |
          echo "Validating evidence bundle structure..."

          BUNDLE_DIR=$(ls -d evidence/A7-bundle/evidence_bundle_* 2>/dev/null | head -1)

          if [ -z "$BUNDLE_DIR" ]; then
            echo "::error::No evidence bundle found"
            exit 1
          fi

          # Check required files
          REQUIRED_FILES=("frequency_report.json" "frequency_report.yaml" "SUMMARY.md")

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$BUNDLE_DIR/$file" ]; then
              echo "::error::Missing required file: $file"
              exit 1
            fi
            echo "âœ“ Found: $file"
          done

          echo "Evidence bundle validation passed!"

  check-thresholds:
    name: Check Frequency Thresholds
    runs-on: ubuntu-latest
    needs: compute-frequency

    steps:
      - name: Evaluate frequency band
        run: |
          F_TOTAL=${{ needs.compute-frequency.outputs.f_total }}
          BAND=${{ needs.compute-frequency.outputs.band }}

          echo "F_total: $F_TOTAL"
          echo "Band: $BAND"

          case $BAND in
            "critical")
              echo "::error::CRITICAL: System frequency below acceptable threshold!"
              exit 1
              ;;
            "low")
              echo "::warning::LOW: System needs attention. Review evidence bundle."
              ;;
            "nominal")
              echo "::notice::NOMINAL: System operating normally."
              ;;
            "optimal")
              echo "::notice::OPTIMAL: System performing well."
              ;;
            "peak")
              echo "::notice::PEAK: Maximum coherence achieved!"
              ;;
          esac

      - name: Check Diamond Hands readiness
        if: needs.compute-frequency.outputs.diamond_ready == 'True'
        run: |
          echo "## Diamond Hands Review Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "System has achieved required frequency for POC advancement." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step**: Request Diamond Hands final review." >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [compute-frequency, check-thresholds]
    if: always()

    steps:
      - name: Prepare notification
        run: |
          F_TOTAL=${{ needs.compute-frequency.outputs.f_total }}
          BAND=${{ needs.compute-frequency.outputs.band }}
          DIAMOND_READY=${{ needs.compute-frequency.outputs.diamond_ready }}

          echo "Frequency calculation complete."
          echo "F_total: $F_TOTAL | Band: $BAND | Diamond Ready: $DIAMOND_READY"

          # Add notification logic here (Slack, email, etc.)
          # Example:
          # if [ "$BAND" == "critical" ]; then
          #   curl -X POST $SLACK_WEBHOOK -d "{\"text\":\"ALERT: System frequency CRITICAL ($F_TOTAL)\"}"
          # fi

      - name: Create issue on critical frequency
        if: needs.compute-frequency.outputs.band == 'critical'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ CRITICAL: System Frequency Below Threshold',
              body: `## Critical Frequency Alert

              **F_total**: ${{ needs.compute-frequency.outputs.f_total }}
              **Band**: CRITICAL
              **Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

              Immediate action required. System frequency has dropped below critical threshold.

              ### Required Actions
              - [ ] Review evidence bundle
              - [ ] Identify root cause
              - [ ] Implement corrective measures
              - [ ] Re-run frequency calculation

              /cc @thunder-strike-squad`,
              labels: ['critical', 'frequency-alert', 'needs-triage']
            })
